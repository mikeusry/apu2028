---
/**
 * CloudinaryImage Component
 *
 * A custom image component for Cloudinary-hosted images that avoids
 * conflicts with Astro's built-in Image component.
 *
 * Usage:
 * <CloudinaryImage
 *   publicId="hero-action-shot"
 *   alt="Ayn Parker Usry batting"
 *   width={800}
 *   height={1000}
 * />
 */

import {
  buildCloudinaryUrl,
  getCloudinaryResponsiveSet,
  type CloudinaryTransformOptions,
} from '../lib/cloudinary';

interface Props {
  /** Public ID of the image in Cloudinary (without folder prefix) */
  publicId: string;
  /** Alt text for accessibility */
  alt: string;
  /** Display width */
  width?: number;
  /** Display height */
  height?: number;
  /** Crop mode */
  crop?: CloudinaryTransformOptions['crop'];
  /** Gravity for cropping */
  gravity?: CloudinaryTransformOptions['gravity'];
  /** Quality setting */
  quality?: CloudinaryTransformOptions['quality'];
  /** Additional CSS classes */
  class?: string;
  /** Loading strategy */
  loading?: 'lazy' | 'eager';
  /** Decoding strategy */
  decoding?: 'async' | 'sync' | 'auto';
  /** Responsive widths for srcset */
  widths?: number[];
  /** Sizes attribute for responsive images */
  sizes?: string;
  /** Fetch priority for LCP images */
  fetchpriority?: 'high' | 'low' | 'auto';
}

const {
  publicId,
  alt,
  width = 800,
  height,
  crop = 'fill',
  gravity = 'auto',
  quality = 'auto',
  class: className = '',
  loading = 'lazy',
  decoding = 'async',
  widths = [400, 800, 1200, 1600],
  sizes = '100vw',
  fetchpriority,
} = Astro.props;

// Build the main image URL
const src = buildCloudinaryUrl(publicId, {
  width,
  height,
  crop,
  gravity,
  quality,
  format: 'auto',
});

// Generate responsive srcset
const srcset = getCloudinaryResponsiveSet(publicId, widths, {
  height: height ? Math.round(height * (widths[0] / width)) : undefined,
  crop,
  gravity,
  quality,
});

// Calculate aspect ratio for layout stability
const aspectRatio = height ? `${width} / ${height}` : undefined;
---

<img
  src={src}
  srcset={srcset}
  sizes={sizes}
  alt={alt}
  width={width}
  height={height}
  loading={loading}
  decoding={decoding}
  fetchpriority={fetchpriority}
  class:list={[className]}
  style={aspectRatio ? `aspect-ratio: ${aspectRatio};` : undefined}
/>
