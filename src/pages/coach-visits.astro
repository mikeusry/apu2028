---
// Coach visits dashboard - Tailwind + Flowbite-style
const isLocal = import.meta.env.DEV;
---

<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Visits | APU</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          }
        }
      }
    </script>
    <style>
      [x-cloak] { display: none !important; }
    </style>
  </head>
  <body class="bg-gray-900 text-white font-sans min-h-screen">
    {isLocal && (
      <div class="bg-gray-800 text-gray-500 text-[10px] text-center py-0.5 font-medium tracking-widest uppercase">
        Local
      </div>
    )}

    <!-- Login -->
    <div id="login" class={`max-w-sm mx-auto px-4 pt-32 ${isLocal ? 'hidden' : ''}`}>
      <div class="text-center mb-8">
        <h1 class="text-xl font-semibold text-white">Coach Visits</h1>
        <p class="text-gray-500 text-sm mt-2">Enter your access key</p>
      </div>
      <input
        type="password"
        id="key"
        placeholder="Access key"
        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      />
      <button
        onclick="load()"
        class="w-full mt-4 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors"
      >
        View Dashboard
      </button>
    </div>

    <!-- Dashboard -->
    <div id="dash" class={`max-w-6xl mx-auto px-4 py-8 ${isLocal ? '' : 'hidden'}`}>
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-2xl font-bold text-white">Ayn Parker Usry</h1>
          <p class="text-gray-500 text-sm">Recruitment activity tracker</p>
        </div>
        <button
          onclick="load()"
          class="px-4 py-2 text-sm font-medium text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700 transition-colors"
        >
          Refresh
        </button>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <p class="text-gray-500 text-xs font-medium uppercase tracking-wider">College Towns</p>
          </div>
          <p id="stat-colleges" class="text-3xl font-bold text-blue-400">0</p>
        </div>
        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            <p class="text-gray-500 text-xs font-medium uppercase tracking-wider">Page Views</p>
          </div>
          <p id="stat-views" class="text-3xl font-bold text-white">0</p>
        </div>
        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-gray-500 text-xs font-medium uppercase tracking-wider">Video Plays</p>
          </div>
          <p id="stat-plays" class="text-3xl font-bold text-emerald-400">0</p>
        </div>
        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-gray-500 text-xs font-medium uppercase tracking-wider">30s+ Engaged</p>
          </div>
          <p id="stat-engaged" class="text-3xl font-bold text-amber-400">0</p>
        </div>
      </div>

      <!-- UTM Sources + College Towns Pills -->
      <div class="flex flex-wrap gap-4 mb-6">
        <div id="utm-sources" class="flex flex-wrap items-center gap-2"></div>
        <div id="college-towns" class="flex flex-wrap items-center gap-2"></div>
      </div>

      <!-- Activity Table -->
      <div class="bg-gray-800 border border-gray-700 rounded-xl overflow-hidden shadow-xl shadow-black/20">
        <!-- Table Header -->
        <div class="px-6 py-4 border-b border-gray-700">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-semibold text-white">Activity Feed</h2>
              <p class="text-gray-500 text-sm">Real-time visitor activity</p>
            </div>
            <button
              id="live-btn"
              onclick="toggleLive()"
              class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/20"
            >
              <span id="live-dot" class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
              <span id="live-text">Live</span>
            </button>
          </div>
          <!-- Filter buttons -->
          <div class="flex items-center gap-2 flex-wrap">
            <button onclick="setFilter('all')" data-filter="all" class="filter-btn active px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-700 text-white">
              All
            </button>
            <button onclick="setFilter('video_play')" data-filter="video_play" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-700/50 text-gray-400 hover:bg-gray-700 hover:text-white transition-colors">
              Videos
            </button>
            <button onclick="setFilter('high_value')" data-filter="high_value" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-700/50 text-purple-400 hover:bg-purple-700/30 hover:text-purple-300 transition-colors border border-purple-500/30">
              High Value
            </button>
            <button onclick="setFilter('engagement')" data-filter="engagement" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-700/50 text-gray-400 hover:bg-gray-700 hover:text-white transition-colors">
              30s+ Only
            </button>
            <button onclick="setFilter('college')" data-filter="college" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-700/50 text-gray-400 hover:bg-gray-700 hover:text-white transition-colors">
              College Towns
            </button>
          </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
          <table class="w-full">
            <thead class="bg-gray-900/80 sticky top-0 z-10">
              <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <th class="px-6 py-3">Type</th>
                <th class="px-6 py-3">Location</th>
                <th class="px-6 py-3">Source / Device</th>
                <th class="px-6 py-3 text-right">Duration</th>
                <th class="px-6 py-3 text-right">Time</th>
              </tr>
            </thead>
            <tbody id="feed-body" class="divide-y divide-gray-700/50">
              <!-- Rows injected by JS -->
            </tbody>
          </table>
        </div>

        <!-- Table Footer -->
        <div class="px-6 py-3 border-t border-gray-700 bg-gray-800/50">
          <p class="text-xs text-gray-500">
            Showing <span id="showing-count" class="font-medium text-gray-300">0</span> of <span id="total-count" class="text-gray-300">0</span> events
          </p>
        </div>
      </div>
    </div>

    <script define:vars={{ isLocal }}>
      // Empty mock data - real data comes from /api/visits in production
      const MOCK = {
        summary: {
          todayPageviews: 0,
          todayVideoPlays: 0,
          uniqueCities: 0,
          totalEngagements: 0,
          citiesVisited: [],
          utmSources: {},
          highValueCounts: {}
        },
        highValueEvents: [],
        todayEvents: []
      };

      const COLLEGES = ['Tallahassee','Gainesville','Knoxville','Athens','Auburn','Starkville','Columbia','Clemson','Tuscaloosa','Lexington','Louisville','Nashville','Boone','Cullowhee','Charleston','Greenville','Spartanburg','Kennesaw','Jacksonville','Tampa','Orlando','Lynchburg','Blacksburg','Charlottesville','Baton Rouge','College Station','Norman','Stillwater','Fayetteville','Oxford'];

      const isCollege = c => c && COLLEGES.some(t => c.toLowerCase().includes(t.toLowerCase()));

      const ago = ts => {
        const m = Math.floor((Date.now() - new Date(ts)) / 60000);
        if (m < 1) return 'Just now';
        if (m < 60) return m + 'm ago';
        const h = Math.floor(m / 60);
        if (h < 24) return h + 'h ago';
        return Math.floor(h / 24) + 'd ago';
      };

      const flag = cc => {
        if (!cc || cc.length !== 2) return '';
        return String.fromCodePoint(...cc.toUpperCase().split('').map(c => 127397 + c.charCodeAt(0)));
      };

      const typeBadge = {
        pageview: { label: 'View', bg: 'bg-gray-500/10', text: 'text-gray-400', border: 'border-gray-500/20' },
        video_play: { label: 'Video', bg: 'bg-blue-500/10', text: 'text-blue-400', border: 'border-blue-500/20' },
        video_progress: { label: 'Watch', bg: 'bg-emerald-500/10', text: 'text-emerald-400', border: 'border-emerald-500/20' },
        engagement: { label: '30s+', bg: 'bg-amber-500/10', text: 'text-amber-400', border: 'border-amber-500/20' },
        resume_download: { label: 'Resume', bg: 'bg-purple-500/10', text: 'text-purple-400', border: 'border-purple-500/20' },
        coach_email_click: { label: 'Email', bg: 'bg-pink-500/10', text: 'text-pink-400', border: 'border-pink-500/20' },
        schedule_view: { label: 'Schedule', bg: 'bg-cyan-500/10', text: 'text-cyan-400', border: 'border-cyan-500/20' },
        section_view: { label: 'Section', bg: 'bg-gray-500/10', text: 'text-gray-400', border: 'border-gray-500/20' },
        contact_form_submit: { label: 'Form', bg: 'bg-rose-500/10', text: 'text-rose-400', border: 'border-rose-500/20' }
      };

      let isLive = true;
      let currentFilter = 'all';
      let allData = null;

      window.toggleLive = function() {
        isLive = !isLive;
        const btn = document.getElementById('live-btn');
        const dot = document.getElementById('live-dot');
        const txt = document.getElementById('live-text');

        if (isLive) {
          btn.className = 'flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/20';
          dot.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse';
          txt.textContent = 'Live';
        } else {
          btn.className = 'flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded-full bg-gray-700 text-gray-400 border border-gray-600';
          dot.className = 'w-2 h-2 rounded-full bg-gray-500';
          txt.textContent = 'Paused';
        }
      };

      window.setFilter = function(filter) {
        currentFilter = filter;
        // Update button styles
        document.querySelectorAll('.filter-btn').forEach(btn => {
          if (btn.dataset.filter === filter) {
            btn.className = 'filter-btn active px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-700 text-white';
          } else {
            btn.className = 'filter-btn px-3 py-1.5 text-xs font-medium rounded-lg bg-gray-700/50 text-gray-400 hover:bg-gray-700 hover:text-white transition-colors';
          }
        });
        if (allData) render(allData);
      };

      function render(d) {
        allData = d;
        const collegeTowns = d.summary.citiesVisited.filter(c => isCollege(c.split(',')[0]));

        // Stats
        document.getElementById('stat-colleges').textContent = collegeTowns.length;
        document.getElementById('stat-views').textContent = d.summary.todayPageviews;
        document.getElementById('stat-plays').textContent = d.summary.todayVideoPlays;
        document.getElementById('stat-engaged').textContent = d.summary.totalEngagements || 0;

        // UTM Sources pills
        const utmEl = document.getElementById('utm-sources');
        const utmSources = d.summary.utmSources || {};
        const utmEntries = Object.entries(utmSources).sort((a, b) => b[1] - a[1]);
        if (utmEntries.length > 0) {
          utmEl.innerHTML = '<span class="text-xs text-gray-500 uppercase tracking-wider mr-1">Sources:</span>' +
            utmEntries.map(([source, count]) => {
              const colors = {
                email: 'bg-purple-500/10 text-purple-400 border-purple-500/20',
                twitter: 'bg-sky-500/10 text-sky-400 border-sky-500/20',
                instagram: 'bg-pink-500/10 text-pink-400 border-pink-500/20',
                google: 'bg-red-500/10 text-red-400 border-red-500/20'
              };
              const color = colors[source.toLowerCase()] || 'bg-gray-500/10 text-gray-400 border-gray-500/20';
              return `<span class="px-2.5 py-1 text-xs font-medium ${color} border rounded-full">${source} (${count})</span>`;
            }).join('');
        } else {
          utmEl.innerHTML = '';
        }

        // College town pills
        const townsEl = document.getElementById('college-towns');
        if (collegeTowns.length > 0) {
          townsEl.innerHTML = '<span class="text-xs text-gray-500 uppercase tracking-wider mr-1">Colleges:</span>' +
            collegeTowns.map(t =>
              `<span class="px-2.5 py-1 text-xs font-medium bg-blue-500/10 text-blue-400 border border-blue-500/20 rounded-full">${t}</span>`
            ).join('');
        } else {
          townsEl.innerHTML = '';
        }

        // Feed table
        const tbody = document.getElementById('feed-body');
        const allEvents = d.todayEvents || [];

        // Apply filter
        let events = allEvents;
        if (currentFilter === 'video_play') {
          events = allEvents.filter(e => e.type === 'video_play' || e.type === 'video_progress');
        } else if (currentFilter === 'high_value') {
          events = allEvents.filter(e => ['resume_download', 'coach_email_click', 'contact_form_submit'].includes(e.type));
        } else if (currentFilter === 'engagement') {
          events = allEvents.filter(e => e.type === 'engagement');
        } else if (currentFilter === 'college') {
          events = allEvents.filter(e => isCollege(e.city));
        }

        if (events.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="px-6 py-16 text-center">
                <div class="text-gray-600 mb-2">
                  <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                  </svg>
                </div>
                <p class="text-gray-500 text-sm">No ${currentFilter === 'all' ? 'activity' : currentFilter.replace('_', ' ')} yet</p>
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = events.map((e, i) => {
            const badge = typeBadge[e.type] || typeBadge.pageview;
            const college = isCollege(e.city);
            const fl = flag(e.country_code || e.country || 'US');
            const rowBg = i % 2 === 0 ? '' : 'bg-gray-900/30';
            // Get source from UTM params or referrer
            const source = e.utm?.utm_source || e.source || (e.referrer ? 'Referral' : 'Direct');
            const campaign = e.utm?.utm_campaign;
            // Highlight high-value events
            const isHighValue = ['resume_download', 'coach_email_click', 'contact_form_submit'].includes(e.type);
            const rowHighlight = isHighValue ? 'border-l-2 border-l-purple-500' : '';

            return `
              <tr class="${rowBg} ${rowHighlight} hover:bg-gray-700/50 transition-colors group">
                <td class="px-6 py-3.5 whitespace-nowrap">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badge.bg} ${badge.text} border ${badge.border}">
                    ${badge.label}
                  </span>
                </td>
                <td class="px-6 py-3.5 whitespace-nowrap">
                  <div class="flex items-center gap-2">
                    <span class="text-base">${fl}</span>
                    <span class="${college ? 'text-blue-400 font-medium' : 'text-gray-200'}">${e.city || 'Unknown'}, ${e.region || ''}</span>
                    ${college ? '<span class="w-1.5 h-1.5 bg-blue-400 rounded-full" title="College Town"></span>' : ''}
                  </div>
                </td>
                <td class="px-6 py-3.5 whitespace-nowrap">
                  <div class="text-sm">
                    <span class="${e.utm?.utm_source ? 'text-purple-400 font-medium' : 'text-gray-300'}">${source}</span>
                    ${campaign ? `<span class="text-gray-600 text-xs ml-1">(${campaign})</span>` : ''}
                    <span class="text-gray-600 mx-1.5">/</span>
                    <span class="text-gray-500">${e.device || 'Unknown'}</span>
                  </div>
                </td>
                <td class="px-6 py-3.5 whitespace-nowrap text-right text-sm tabular-nums">
                  ${e.duration ? `<span class="text-emerald-400 font-medium">${e.duration}</span>` : '<span class="text-gray-700">â€”</span>'}
                </td>
                <td class="px-6 py-3.5 whitespace-nowrap text-right text-sm text-gray-500 tabular-nums" title="${new Date(e.timestamp).toLocaleString()}">
                  ${ago(e.timestamp)}
                </td>
              </tr>
            `;
          }).join('');
        }

        document.getElementById('showing-count').textContent = events.length;
        document.getElementById('total-count').textContent = allEvents.length;
      }

      window.load = async function() {
        if (isLocal) { render(MOCK); return; }

        const key = document.getElementById('key')?.value;
        if (!key) return;

        try {
          const r = await fetch(`/api/visits?key=${encodeURIComponent(key)}`);
          if (!r.ok) {
            if (r.status === 401) alert('Invalid key');
            return;
          }
          const d = await r.json();
          document.getElementById('login').classList.add('hidden');
          document.getElementById('dash').classList.remove('hidden');
          render(d);
          sessionStorage.setItem('k', key);
        } catch (e) {
          console.error(e);
          alert('Error loading data');
        }
      };

      window.onload = () => {
        if (isLocal) { window.load(); return; }
        const k = sessionStorage.getItem('k');
        if (k) {
          document.getElementById('key').value = k;
          window.load();
        }
        document.getElementById('key')?.addEventListener('keypress', e => {
          if (e.key === 'Enter') window.load();
        });
      };
    </script>
  </body>
</html>
